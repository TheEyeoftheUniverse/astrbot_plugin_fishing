{% extends "layout.html" %}

{% block title %}é…’é¦† - é’“é±¼æ’ä»¶{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="fas fa-beer"></i> æ¸”å¤«é…’é¦†</h2>
        <p class="text-muted">ç©ºå†›æ¸”å¤«åœ¨çº¿å‘ç‰Œ ğŸ´</p>
    </div>
</div>

<!-- å…¬å‘Šæ  -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-thumbtack"></i> é…’é¦†å…¬å‘Š</h5>
                {% if is_admin %}
                <button class="btn btn-sm btn-dark" onclick="editAnnouncement()">
                    <i class="fas fa-edit"></i> ç¼–è¾‘
                </button>
                {% endif %}
            </div>
            <div class="card-body">
                <div id="announcementContent" class="announcement-content">
                    {{ announcement | safe if announcement else '<p class="text-muted">æš‚æ— å…¬å‘Š</p>' }}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ’è¡Œæ¦œ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <button class="btn btn-link text-white text-decoration-none w-100 text-start p-0" 
                            type="button" data-bs-toggle="collapse" data-bs-target="#leaderboardCollapse">
                        <h5 class="mb-0">
                            <i class="fas fa-trophy"></i> é’“é±¼ä½¬æ’è¡Œæ¦œ
                            <i class="fas fa-chevron-down ms-2"></i>
                        </h5>
                    </button>
                    <button class="btn btn-sm btn-light" onclick="refreshLeaderboard()">
                        <i class="fas fa-sync"></i> åˆ·æ–°
                    </button>
                </div>
            </div>
            <div class="collapse" id="leaderboardCollapse">
                <div class="card-body">
                    <!-- æ’è¡Œæ¦œæ ‡ç­¾é¡µ -->
                    <ul class="nav nav-tabs mb-3" id="leaderboardTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="coins-tab" data-bs-toggle="tab" 
                                    data-bs-target="#coins-leaderboard" type="button" role="tab">
                                <i class="fas fa-coins text-warning"></i> é‡‘å¸æ¦œ
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="fishing-tab" data-bs-toggle="tab" 
                                    data-bs-target="#fishing-leaderboard" type="button" role="tab">
                                <i class="fas fa-fish text-info"></i> é’“é±¼æ¬¡æ•°æ¦œ
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="weight-tab" data-bs-toggle="tab" 
                                    data-bs-target="#weight-leaderboard" type="button" role="tab">
                                <i class="fas fa-weight-hanging text-primary"></i> æ€»é‡é‡æ¦œ
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="earned-tab" data-bs-toggle="tab" 
                                    data-bs-target="#earned-leaderboard" type="button" role="tab">
                                <i class="fas fa-chart-line text-success"></i> ç´¯è®¡æ”¶å…¥æ¦œ
                            </button>
                        </li>
                    </ul>

                    <!-- æ’è¡Œæ¦œå†…å®¹ -->
                    <div class="tab-content" id="leaderboardTabContent">
                        <!-- é‡‘å¸æ¦œ -->
                        <div class="tab-pane fade show active" id="coins-leaderboard" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>æ’å</th>
                                            <th>é’“é±¼ä½¬</th>
                                            <th>é‡‘å¸</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for rank in leaderboard.coins %}
                                        <tr {% if rank.user_id == current_user_id %}class="table-primary"{% endif %}>
                                            <td>
                                                {% if rank.rank == 1 %}
                                                <i class="fas fa-crown text-warning"></i>
                                                {% elif rank.rank == 2 %}
                                                <i class="fas fa-medal text-secondary"></i>
                                                {% elif rank.rank == 3 %}
                                                <i class="fas fa-medal" style="color: #cd7f32;"></i>
                                                {% else %}
                                                {{ rank.rank }}
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ rank.nickname or 'æ¸”å¤«' + rank.user_id[-4:] }}                                                {% if rank.title and rank.title != 'æ— ç§°å·' %}
                                                <span class="badge bg-success" style="font-size: 0.75rem;">{{ rank.title }}</span>
                                                {% endif %}                                                {% if rank.title and rank.title != 'æ— ç§°å·' %}
                                                <span class="badge bg-success" style="font-size: 0.75rem;">{{ rank.title }}</span>
                                                {% endif %}
                                                {% if rank.user_id == current_user_id %}
                                                <span class="badge bg-primary">ä½ </span>
                                                {% endif %}
                                            </td>
                                            <td><strong class="text-warning">{{ rank.coins | default(0) }}</strong></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- é’“é±¼æ¬¡æ•°æ¦œ -->
                        <div class="tab-pane fade" id="fishing-leaderboard" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>æ’å</th>
                                            <th>é’“é±¼ä½¬</th>
                                            <th>é’“é±¼æ¬¡æ•°</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for rank in leaderboard.fishing %}
                                        <tr {% if rank.user_id == current_user_id %}class="table-primary"{% endif %}>
                                            <td>
                                                {% if rank.rank == 1 %}
                                                <i class="fas fa-crown text-warning"></i>
                                                {% elif rank.rank == 2 %}
                                                <i class="fas fa-medal text-secondary"></i>
                                                {% elif rank.rank == 3 %}
                                                <i class="fas fa-medal" style="color: #cd7f32;"></i>
                                                {% else %}
                                                {{ rank.rank }}
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ rank.nickname or 'æ¸”å¤«' + rank.user_id[-4:] }}
                                                {% if rank.title and rank.title != 'æ— ç§°å·' %}
                                                <span class="badge bg-success" style="font-size: 0.75rem;">{{ rank.title }}</span>
                                                {% endif %}
                                                {% if rank.user_id == current_user_id %}
                                                <span class="badge bg-primary">ä½ </span>
                                                {% endif %}
                                            </td>
                                            <td><strong class="text-info">{{ rank.total_fishing_count | default(0) }}</strong></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- æ€»é‡é‡æ¦œ -->
                        <div class="tab-pane fade" id="weight-leaderboard" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>æ’å</th>
                                            <th>é’“é±¼ä½¬</th>
                                            <th>æ€»é‡é‡ (kg)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for rank in leaderboard.weight %}
                                        <tr {% if rank.user_id == current_user_id %}class="table-primary"{% endif %}>
                                            <td>
                                                {% if rank.rank == 1 %}
                                                <i class="fas fa-crown text-warning"></i>
                                                {% elif rank.rank == 2 %}
                                                <i class="fas fa-medal text-secondary"></i>
                                                {% elif rank.rank == 3 %}
                                                <i class="fas fa-medal" style="color: #cd7f32;"></i>
                                                {% else %}
                                                {{ rank.rank }}
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ rank.nickname or 'æ¸”å¤«' + rank.user_id[-4:] }}
                                                {% if rank.title and rank.title != 'æ— ç§°å·' %}
                                                <span class="badge bg-success" style="font-size: 0.75rem;">{{ rank.title }}</span>
                                                {% endif %}
                                                {% if rank.user_id == current_user_id %}
                                                <span class="badge bg-primary">ä½ </span>
                                                {% endif %}
                                            </td>
                                            <td><strong class="text-primary">{{ (rank.total_weight_caught | default(0) / 1000) | round(2) }}</strong></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- ç´¯è®¡æ”¶å…¥æ¦œ -->
                        <div class="tab-pane fade" id="earned-leaderboard" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>æ’å</th>
                                            <th>é’“é±¼ä½¬</th>
                                            <th>ç´¯è®¡æ”¶å…¥</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for rank in leaderboard.earned %}
                                        <tr {% if rank.user_id == current_user_id %}class="table-primary"{% endif %}>
                                            <td>
                                                {% if rank.rank == 1 %}
                                                <i class="fas fa-crown text-warning"></i>
                                                {% elif rank.rank == 2 %}
                                                <i class="fas fa-medal text-secondary"></i>
                                                {% elif rank.rank == 3 %}
                                                <i class="fas fa-medal" style="color: #cd7f32;"></i>
                                                {% else %}
                                                {{ rank.rank }}
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ rank.nickname or 'æ¸”å¤«' + rank.user_id[-4:] }}
                                                {% if rank.title and rank.title != 'æ— ç§°å·' %}
                                                <span class="badge bg-success" style="font-size: 0.75rem;">{{ rank.title }}</span>
                                                {% endif %}
                                                {% if rank.user_id == current_user_id %}
                                                <span class="badge bg-primary">ä½ </span>
                                                {% endif %}
                                            </td>
                                            <td><strong class="text-success">{{ rank.total_coins_earned | default(0) }}</strong></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç§‘è€ƒå…¬å‘Šæ¿ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <button class="btn btn-link text-white text-decoration-none w-100 text-start p-0" 
                        type="button" data-bs-toggle="collapse" data-bs-target="#expeditionCollapse">
                    <h5 class="mb-0">
                        <i class="fas fa-compass"></i> ç§‘å­¦è€ƒå¯Ÿå…¬å‘Šæ¿
                        {% if expeditions %}
                        <span class="badge bg-light text-info ms-2">{{ expeditions|length }} ä¸ªè¿›è¡Œä¸­</span>
                        {% else %}
                        <span class="badge bg-secondary ms-2">0 ä¸ªè¿›è¡Œä¸­</span>
                        {% endif %}
                        <i class="fas fa-chevron-down ms-2"></i>
                    </h5>
                </button>
            </div>
            <div class="collapse show" id="expeditionCollapse">
                <div class="card-body">
                    {% if expeditions %}
                        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                            {% for exp in expeditions %}
                            <div class="col">
                                <div class="card h-100 expedition-card {% if exp.type == 'short' %}border-success{% elif exp.type == 'medium' %}border-warning{% else %}border-danger{% endif %}">
                                    <div class="card-header {% if exp.type == 'short' %}bg-success{% elif exp.type == 'medium' %}bg-warning{% else %}bg-danger{% endif %} text-white d-flex justify-content-between align-items-center">
                                        <strong>
                                            {% if exp.type == 'short' %}
                                            <i class="fas fa-leaf"></i> æ¢é™©ç§‘è€ƒ
                                            {% elif exp.type == 'medium' %}
                                            <i class="fas fa-compass"></i> å¾æœç§‘è€ƒ
                                            {% else %}
                                            <i class="fas fa-rocket"></i> åœ£åŸŸç§‘è€ƒ
                                            {% endif %}
                                        </strong>
                                        <span class="badge bg-light text-dark">{{ exp.member_count }}äºº</span>
                                    </div>
                                    <div class="card-body d-flex flex-column">
                                        <div class="mb-2">
                                            <small class="text-muted">
                                                <i class="fas fa-user"></i> é˜Ÿé•¿ï¼š{{ exp.creator_name }}
                                            </small>
                                        </div>
                                        <div class="mb-2">
                                            <small class="text-muted">
                                                <i class="fas fa-clock"></i> å‰©ä½™æ—¶é—´ï¼š{{ exp.remaining_hours }}å°æ—¶{{ exp.remaining_minutes }}åˆ†é’Ÿ
                                            </small>
                                        </div>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <small><strong>æ€»è¿›åº¦</strong></small>
                                                <small class="text-muted">{{ (exp.total_progress * 100)|round(1) }}%</small>
                                            </div>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-info progress-bar-striped progress-bar-animated" 
                                                     role="progressbar" 
                                                     style="width: {{ (exp.total_progress * 100)|round(1) }}%"
                                                     aria-valuenow="{{ (exp.total_progress * 100)|round(1) }}" 
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100">
                                                    {{ (exp.total_progress * 100)|round(1) }}%
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <small><strong>ç›®æ ‡é±¼ç±»</strong></small>
                                            <div class="mt-1">
                                                {% for key, target in exp.targets.items() %}
                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                    <span class="small">
                                                        {{ 'â­' * target.rarity }} {{ target.fish_name }}
                                                    </span>
                                                    <span class="small text-muted">{{ target.caught }}/{{ target.required }}</span>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="mt-auto">
                                            <button class="btn btn-sm btn-outline-primary w-100" 
                                                    onclick="copyExpeditionCode('{{ exp.expedition_id }}')">
                                                <i class="fas fa-copy"></i> å¤åˆ¶é‚€è¯·ç 
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-compass fa-3x mb-3"></i>
                            <p>æš‚æ— è¿›è¡Œä¸­çš„ç§‘å­¦è€ƒå¯Ÿ</p>
                            <small>ä½¿ç”¨å‘½ä»¤ <code>,å‘èµ·ç§‘è€ƒ æ¢é™©|å¾æœ|åœ£åŸŸ</code> å‘èµ·ç§‘è€ƒé˜Ÿä¼</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ä»Šæ—¥æ°´æ—ç®±å±•è§ˆä¼š -->
{% if exhibition and exhibition.featured_user %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <button class="btn btn-link text-white text-decoration-none w-100 text-start p-0" 
                        type="button" data-bs-toggle="collapse" data-bs-target="#exhibitionCollapse">
                    <h5 class="mb-0">
                        <i class="fas fa-fish"></i> ä»Šæ—¥æ°´æ—ç®±å±•è§ˆä¼š
                        <i class="fas fa-chevron-down ms-2"></i>
                    </h5>
                </button>
            </div>
            <div class="collapse show" id="exhibitionCollapse">
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-star"></i> ä»Šæ—¥å±•è§ˆè€…ï¼š
                        <strong>{{ exhibition.featured_user.nickname }}</strong>
                        <span class="badge bg-success ms-1">{{ exhibition.featured_user.current_title }}</span>
                        <br>
                        <small>
                            TAçš„æ°´æ—ç®±é‡Œæœ‰è¶³è¶³ <strong style="color: #ffffff; text-shadow: 0 0 10px rgba(255,255,255,0.8);">{{ exhibition.featured_user.stats.total_count | default(0) }}</strong> æ¡é±¼ï¼Œ
                            æ€»ä»·å€¼ç«Ÿé«˜è¾¾ <strong style="color: #ffd700; text-shadow: 0 0 10px rgba(255,215,0,0.8);">{{ exhibition.featured_user.stats.total_value | default(0) }}</strong> é‡‘å¸ï¼
                        </small>
                    </div>

                    <!-- è£…å¤‡å±•ç¤º -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="fas fa-fishing-rod text-primary"></i> é±¼ç«¿</h6>
                                    {% if exhibition.featured_user.equipped_rod %}
                                        <p class="mb-1">{{ exhibition.featured_user.equipped_rod.name }}</p>
                                        <small class="text-warning">{{ 'â˜…' * exhibition.featured_user.equipped_rod.rarity }}</small>
                                        {% if exhibition.featured_user.equipped_rod.refine_level > 0 %}
                                        <small class="text-success"> +{{ exhibition.featured_user.equipped_rod.refine_level }}</small>
                                        {% endif %}
                                    {% else %}
                                        <p class="text-muted mb-0">æœªè£…å¤‡</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="fas fa-ring text-info"></i> é¥°å“</h6>
                                    {% if exhibition.featured_user.equipped_accessory %}
                                        <p class="mb-1">{{ exhibition.featured_user.equipped_accessory.name }}</p>
                                        <small class="text-warning">{{ 'â˜…' * exhibition.featured_user.equipped_accessory.rarity }}</small>
                                        {% if exhibition.featured_user.equipped_accessory.refine_level > 0 %}
                                        <small class="text-success"> +{{ exhibition.featured_user.equipped_accessory.refine_level }}</small>
                                        {% endif %}
                                    {% else %}
                                        <p class="text-muted mb-0">æœªè£…å¤‡</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="fas fa-cookie-bite text-warning"></i> é±¼é¥µ</h6>
                                    {% if exhibition.featured_user.current_bait %}
                                        <p class="mb-1">{{ exhibition.featured_user.current_bait.name }}</p>
                                        <small class="text-warning">{{ 'â˜…' * exhibition.featured_user.current_bait.rarity }}</small>
                                        <small class="text-muted"> (å‰©ä½™ {{ exhibition.featured_user.current_bait.quantity }})</small>
                                    {% else %}
                                        <p class="text-muted mb-0">æœªä½¿ç”¨</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ç¨€æœ‰åº¦ç­›é€‰ -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm active" onclick="filterExhibitionByRarity('all')">
                                    <i class="fas fa-th"></i> å…¨éƒ¨
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterExhibitionByRarity(1)">æ™®é€š</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterExhibitionByRarity(2)">å¸¸è§</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterExhibitionByRarity(3)">ä¼˜è´¨</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterExhibitionByRarity(4)">ç¨€æœ‰</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterExhibitionByRarity(5)">å²è¯—</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterExhibitionByRarity(6)">ä¼ è¯´</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterExhibitionByRarity(7)">ç¥è¯</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterExhibitionByRarity(8)">è¿œå¤</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterExhibitionByRarity(9)">æ°¸æ’</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterExhibitionByRarity(10)">è‡³é«˜</button>
                            </div>
                        </div>
                    </div>

                    <!-- æ°´æ—ç®±é±¼ç±»å±•ç¤º -->
                    <h6 class="mb-3"><i class="fas fa-water"></i> æ°´æ—ç®±æ”¶è—</h6>
                    <div class="row g-2">
                        {% for fish in exhibition.featured_user.aquarium %}
                        {% set fish_key = fish.fish_id|string + '-' + fish.quality_level|string %}
                        <div class="col-md-4 col-lg-3 exhibition-fish-card" data-rarity="{{ fish.rarity }}">
                            <div class="card h-100 {% if fish.quality_level == 1 %}border-warning{% else %}border-info{% endif %}">
                                <div class="card-body p-2 d-flex flex-column">
                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                        <div class="flex-grow-1">
                                            <h6 class="card-title mb-0">
                                                {{ fish.name }}
                                                {% if fish.quality_level == 1 %}
                                                    <span class="badge bg-warning text-dark" style="font-size: 0.65rem;">âœ¨</span>
                                                {% endif %}
                                            </h6>
                                            <small class="badge bg-info" style="font-size: 0.65rem;">
                                                {% for i in range(fish.rarity) %}â˜…{% endfor %}
                                            </small>
                                        </div>
                                        <h6 class="mb-0 text-primary">Ã—{{ fish.quantity }}</h6>
                                    </div>
                                    
                                    <hr class="my-1">
                                    
                                    <!-- é±¼ç±»æè¿°ï¼ˆå›ºå®šé«˜åº¦ï¼Œå¯æ»šåŠ¨ï¼‰ -->
                                    <p class="card-text mb-2 text-muted" style="font-size: 0.8rem; height: 60px; overflow-y: auto;">
                                        {{ fish.description | default('æš‚æ— æè¿°') }}
                                    </p>
                                    
                                    <!-- ç»Ÿè®¡æ•°æ®ï¼ˆå·²éšè—é‡é‡ï¼Œä»…ä¿ç•™å ä½ä»¥ä¿æŒå¸ƒå±€ä¸€è‡´ï¼‰ -->
                                    <div class="small text-muted mb-2" style="display:none;">
                                        {% if fish.max_weight %}
                                        <div class="d-flex justify-content-between mb-1">
                                            <span><i class="fas fa-weight-hanging"></i> æœ€å¤§é‡é‡:</span>
                                            <strong>{{ "%.2f"|format(fish.max_weight / 1000) }}kg</strong>
                                        </div>
                                        {% endif %}
                                        {% if fish.min_weight %}
                                        <div class="d-flex justify-content-between mb-1">
                                            <span><i class="fas fa-weight-hanging"></i> æœ€å°é‡é‡:</span>
                                            <strong>{{ "%.2f"|format(fish.min_weight / 1000) }}kg</strong>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- ä»·å€¼ä¿¡æ¯ï¼ˆå‚è€ƒå›¾é‰´é¡µï¼Œå·¦å¯¹é½ï¼‰ -->
                                    <div class="mb-2">
                                        <small class="text-muted">
                                            <i class="fas fa-coins text-warning"></i> {{ fish.actual_value | default(fish.base_value | default(0)) }}
                                        </small>
                                    </div>

                                    <!-- è¯„è®ºåŒºï¼ˆä½¿ç”¨ mt-auto æ¨åˆ°åº•éƒ¨ï¼‰ -->
                                    <div class="border-top pt-2 mt-auto">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <button class="btn btn-sm btn-outline-primary w-100" 
                                                    type="button"
                                                    data-bs-toggle="collapse" 
                                                    data-bs-target="#comments-collapse-{{ fish_key }}"
                                                    aria-expanded="false">
                                                <i class="fas fa-comment"></i> ç•™è¨€æ¿
                                                {% set fish_comments = exhibition.comments.get(fish_key, []) %}
                                                <span class="badge {% if fish_comments %}bg-primary{% else %}bg-secondary{% endif %} ms-1">{{ fish_comments|length if fish_comments else 0 }}</span>
                                            </button>
                                        </div>
                                        
                                        <!-- è¯„è®ºåŒºåŸŸï¼ˆé»˜è®¤æŠ˜å ï¼Œå±•å¼€æ—¶è‡ªåŠ¨æ˜¾ç¤ºè¾“å…¥æ¡†ï¼‰ -->
                                        <div class="collapse mt-2" id="comments-collapse-{{ fish_key }}">
                                            <!-- è¯„è®ºè¾“å…¥æ¡†ï¼ˆå±•å¼€æ—¶è‡ªåŠ¨æ˜¾ç¤ºï¼‰ -->
                                            <div id="comment-box-{{ fish_key }}" class="mb-2">
                                                <textarea class="form-control form-control-sm mb-1" 
                                                          id="comment-input-{{ fish_key }}" 
                                                          rows="2" 
                                                          placeholder="å‘è¡¨ä½ çš„æƒ³æ³•ï¼ˆå¦‚æ±‚è´­ä¿¡æ¯ï¼‰..." 
                                                          maxlength="200"></textarea>
                                                <div class="text-end">
                                                    <button class="btn btn-sm btn-primary" 
                                                            onclick="postExhibitionComment('{{ fish_key }}')">å‘é€</button>
                                                </div>
                                            </div>
                                            
                                            <hr class="my-2">

                                            <!-- è¯„è®ºåˆ—è¡¨ -->
                                            <div id="comments-{{ fish_key }}" style="max-height: 200px; overflow-y: auto;">
                                                {% if fish_comments %}
                                                    {% for comment in fish_comments %}
                                                    <div class="alert alert-light py-1 mb-1" style="font-size: 0.75rem;" data-comment-id="{{ comment.id }}">
                                                        <div class="d-flex justify-content-between">
                                                            <div>
                                                                <strong>{{ comment.username }}:</strong>
                                                                {{ comment.content }}
                                                            </div>
                                                            {% if comment.user_id == current_user_id or exhibition.featured_user.user_id == current_user_id %}
                                                            <button class="btn btn-sm btn-link text-danger p-0 ms-1" 
                                                                    onclick="deleteExhibitionComment('{{ fish_key }}', '{{ comment.id }}')">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                            {% endif %}
                                                        </div>
                                                        <div class="text-muted" style="font-size: 0.65rem;">{{ comment.timestamp }}</div>
                                                    </div>
                                                    {% endfor %}
                                                {% else %}
                                                    <div class="text-muted small text-center">æš‚æ— ç•™è¨€</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- ç•™è¨€æ¿ -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <button class="btn btn-link text-white text-decoration-none w-100 text-start p-0" 
                        type="button" data-bs-toggle="collapse" data-bs-target="#messageboardCollapse">
                    <h5 class="mb-0">
                        <i class="fas fa-comments"></i> ç•™è¨€æ¿
                        {% if messages %}
                        <span class="badge bg-light text-primary ms-2">{{ messages|length }} æ¡ç•™è¨€</span>
                        {% else %}
                        <span class="badge bg-secondary ms-2">0 æ¡ç•™è¨€</span>
                        {% endif %}
                        <i class="fas fa-chevron-down ms-2"></i>
                    </h5>
                </button>
            </div>
            <div class="collapse show" id="messageboardCollapse">
            <div class="card-body">
                <!-- å‘è¡¨ç•™è¨€ -->
                <div class="card bg-light mb-4">
                    <div class="card-body">
                        <h6 class="mb-3"><i class="fas fa-pen"></i> å‘è¡¨ç•™è¨€</h6>
                        <textarea id="messageInput" class="form-control mb-3" rows="3" 
                                  placeholder="åˆ†äº«ä½ çš„é’“é±¼æ•…äº‹ã€ç©ºå†›ç»å†æˆ–æ˜¯åæ§½..." maxlength="500"></textarea>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <span id="charCount">0</span>/500 å­—
                            </small>
                            <button class="btn btn-primary" onclick="postMessage()">
                                <i class="fas fa-paper-plane"></i> å‘é€
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ç•™è¨€åˆ—è¡¨ -->
                <div id="messageList">
                    {% if messages %}
                        {% for msg in messages %}
                        <div class="card mb-3 message-item" data-message-id="{{ msg.id }}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <strong class="text-primary">
                                            <i class="fas fa-user-circle"></i> 
                                            {{ msg.username }}
                                            {% if msg.user_id == '2645956495' %}
                                            <span class="badge bg-danger ms-1">ç®¡ç†å‘˜</span>
                                            {% endif %}
                                        </strong>
                                        <small class="text-muted ms-2">
                                            <i class="fas fa-clock"></i> {{ msg.timestamp }}
                                        </small>
                                    </div>
                                    {% if msg.user_id == current_user_id or is_admin %}
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteMessage('{{ msg.id }}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                                <p class="mb-0" style="white-space: pre-wrap;">{{ msg.content }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info text-center">
                            <i class="fas fa-inbox"></i> è¿˜æ²¡æœ‰ç•™è¨€ï¼Œå¿«æ¥æŠ¢æ²™å‘å§ï¼
                        </div>
                    {% endif %}
                </div>

                <!-- åˆ†é¡µ -->
                {% if total_pages > 1 %}
                <nav aria-label="ç•™è¨€åˆ†é¡µ">
                    <ul class="pagination justify-content-center">
                        {% if page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page - 1 }}">ä¸Šä¸€é¡µ</a>
                        </li>
                        {% endif %}
                        
                        {% for p in range(1, total_pages + 1) %}
                        <li class="page-item {% if p == page %}active{% endif %}">
                            <a class="page-link" href="?page={{ p }}">{{ p }}</a>
                        </li>
                        {% endfor %}
                        
                        {% if page < total_pages %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page + 1 }}">ä¸‹ä¸€é¡µ</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
            </div>
        </div>
    </div>
</div>

<!-- ç¼–è¾‘å…¬å‘Šæ¨¡æ€æ¡† -->
<div class="modal fade" id="editAnnouncementModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit"></i> ç¼–è¾‘å…¬å‘Š</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">å…¬å‘Šå†…å®¹ï¼ˆæ”¯æŒHTMLï¼‰</label>
                    <textarea id="announcementEdit" class="form-control" rows="8" 
                              placeholder="å¯ä»¥ä½¿ç”¨HTMLæ ¼å¼...">{{ announcement }}</textarea>
                    <small class="text-muted">æç¤ºï¼šæ”¯æŒHTMLæ ‡ç­¾ï¼Œå¦‚ &lt;strong&gt;ã€&lt;em&gt;ã€&lt;br&gt; ç­‰</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveAnnouncement()">
                    <i class="fas fa-save"></i> ä¿å­˜
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// å­—ç¬¦è®¡æ•°
document.getElementById('messageInput').addEventListener('input', function() {
    const count = this.value.length;
    document.getElementById('charCount').textContent = count;
    
    if (count > 500) {
        this.value = this.value.substring(0, 500);
        document.getElementById('charCount').textContent = 500;
    }
});

// å‘è¡¨ç•™è¨€
async function postMessage() {
    const content = document.getElementById('messageInput').value.trim();
    
    if (!content) {
        showToast('è¯·è¾“å…¥ç•™è¨€å†…å®¹', 'error');
        return;
    }
    
    if (content.length > 500) {
        showToast('ç•™è¨€å†…å®¹ä¸èƒ½è¶…è¿‡500å­—', 'error');
        return;
    }
    
    try {
        const response = await fetch('{{ url_for("player_bp.api_post_message") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ content: content })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('ç•™è¨€å‘è¡¨æˆåŠŸï¼', 'success');
            setTimeout(() => location.reload(), 500);
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
    }
}

// åˆ é™¤ç•™è¨€
async function deleteMessage(messageId) {
    if (!confirm('ç¡®è®¤åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿ')) {
        return;
    }
    
    try {
        const response = await fetch('{{ url_for("player_bp.api_delete_message") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ message_id: messageId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('ç•™è¨€å·²åˆ é™¤', 'success');
            // ç§»é™¤å…ƒç´ 
            const element = document.querySelector(`[data-message-id="${messageId}"]`);
            if (element) {
                element.style.transition = 'opacity 0.3s';
                element.style.opacity = '0';
                setTimeout(() => element.remove(), 300);
            }
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
    }
}

// ç¼–è¾‘å…¬å‘Š
function editAnnouncement() {
    const modal = new bootstrap.Modal(document.getElementById('editAnnouncementModal'));
    modal.show();
}

// ä¿å­˜å…¬å‘Š
async function saveAnnouncement() {
    const content = document.getElementById('announcementEdit').value;
    
    try {
        const response = await fetch('{{ url_for("player_bp.api_update_announcement") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ content: content })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('å…¬å‘Šæ›´æ–°æˆåŠŸï¼', 'success');
            setTimeout(() => location.reload(), 500);
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
    }
}

// å›è½¦å‘é€ï¼ˆCtrl+Enterï¼‰
document.getElementById('messageInput').addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'Enter') {
        postMessage();
    }
});

// åˆ·æ–°æ’è¡Œæ¦œ
async function refreshLeaderboard() {
    showToast('æ­£åœ¨åˆ·æ–°æ’è¡Œæ¦œ...', 'info');
    setTimeout(() => location.reload(), 500);
}

// æ˜¾ç¤ºè¯„è®ºæ¡†
function showCommentBox(fishKey) {
    document.getElementById(`comment-box-${fishKey}`).style.display = 'block';
}

// éšè—è¯„è®ºæ¡†
function hideCommentBox(fishKey) {
    document.getElementById(`comment-box-${fishKey}`).style.display = 'none';
    document.getElementById(`comment-input-${fishKey}`).value = '';
}

// å‘è¡¨å±•è§ˆè¯„è®º
async function postExhibitionComment(fishKey) {
    const content = document.getElementById(`comment-input-${fishKey}`).value.trim();
    
    if (!content) {
        showToast('è¯·è¾“å…¥è¯„è®ºå†…å®¹', 'error');
        return;
    }
    
    if (content.length > 200) {
        showToast('è¯„è®ºå†…å®¹ä¸èƒ½è¶…è¿‡200å­—', 'error');
        return;
    }
    
    try {
        const response = await fetch('{{ url_for("player_bp.api_add_exhibition_comment") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                fish_key: fishKey,
                content: content 
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('è¯„è®ºå‘è¡¨æˆåŠŸï¼', 'success');
            setTimeout(() => location.reload(), 500);
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
    }
}

// åˆ é™¤å±•è§ˆè¯„è®º
async function deleteExhibitionComment(fishKey, commentId) {
    if (!confirm('ç¡®è®¤åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) {
        return;
    }
    
    try {
        const response = await fetch('{{ url_for("player_bp.api_delete_exhibition_comment") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                fish_key: fishKey,
                comment_id: commentId 
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('è¯„è®ºå·²åˆ é™¤', 'success');
            // ç§»é™¤è¯„è®ºå…ƒç´ 
            const element = document.querySelector(`[data-comment-id="${commentId}"]`);
            if (element) {
                element.style.transition = 'opacity 0.3s';
                element.style.opacity = '0';
                setTimeout(() => element.remove(), 300);
            }
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
    }
}

// å±•è§ˆç¨€æœ‰åº¦ç­›é€‰åŠŸèƒ½
function filterExhibitionByRarity(rarity) {
    const cards = document.querySelectorAll('.exhibition-fish-card');
    const buttons = document.querySelectorAll('.btn-group button');
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    if (rarity === 'all') {
        cards.forEach(card => card.style.display = '');
    } else {
        cards.forEach(card => {
            if (card.dataset.rarity == rarity) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    }
}

// å¤åˆ¶ç§‘è€ƒé‚€è¯·ç 
function copyExpeditionCode(code) {
    // åˆ›å»ºä¸´æ—¶è¾“å…¥æ¡†
    const tempInput = document.createElement('input');
    tempInput.value = code;
    document.body.appendChild(tempInput);
    
    // é€‰ä¸­å¹¶å¤åˆ¶
    tempInput.select();
    tempInput.setSelectionRange(0, 99999); // å…¼å®¹ç§»åŠ¨è®¾å¤‡
    
    try {
        document.execCommand('copy');
        showToast('é‚€è¯·ç å·²å¤åˆ¶ï¼š' + code, 'success');
    } catch (err) {
        showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š' + code, 'error');
    }
    
    // ç§»é™¤ä¸´æ—¶è¾“å…¥æ¡†
    document.body.removeChild(tempInput);
}
</script>

<style>
.announcement-content {
    font-size: 1.1em;
    line-height: 1.8;
}

.message-item {
    transition: all 0.3s ease;
}

.message-item:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.expedition-card {
    transition: all 0.3s ease;
}

.expedition-card:hover {
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}
</style>
{% endblock %}
