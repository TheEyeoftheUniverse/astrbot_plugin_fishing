{% extends "layout.html" %}

{% block title %}æ°´æ—ç®± - é’“é±¼æ¸¸æˆ{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="mb-0">
            <i class="fas fa-water"></i> æ°´æ—ç®±
        </h2>
        <p class="text-muted mt-2">æ¬£èµæ‚¨æ”¶è—çš„çè´µé±¼ç±»</p>
    </div>
</div>

<!-- ç»Ÿè®¡ä¿¡æ¯ -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-layer-group"></i> å®¹é‡</h5>
                <h2 class="mb-0">{{ stats.total_count or 0 }} / {{ stats.capacity or 0 }}</h2>
                <div class="progress mt-2" style="height: 8px;">
                    <div class="progress-bar bg-white" role="progressbar" 
                         style="width: {{ (stats.total_count / stats.capacity * 100) if stats.capacity > 0 else 0 }}%">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-fish"></i> é±¼ç±»æ€»æ•°</h5>
                <h2 class="mb-0">{{ stats.total_count or 0 }}</h2>
                <small>æ¡é±¼</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-coins"></i> æ€»ä»·å€¼</h5>
                <h2 class="mb-0">{{ stats.total_value or 0 }}</h2>
                <small>é‡‘å¸</small>
            </div>
        </div>
    </div>
</div>

<!-- æ‰¹é‡æ“ä½œ -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card bg-warning text-white">
            <div class="card-body py-2">
                <button class="btn btn-light btn-sm" onclick="showBatchRemoveFromAquarium()">
                    <i class="fas fa-arrow-left"></i> æ‰¹é‡ç§»å›é±¼å¡˜
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ç¨€æœ‰åº¦ç­›é€‰ -->
<div class="row mb-3">
    <div class="col-12">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary btn-sm active" onclick="filterByRarity('all')">
                <i class="fas fa-th"></i> å…¨éƒ¨
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterByRarity(1)">æ™®é€š</button>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterByRarity(2)">å¸¸è§</button>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterByRarity(3)">ä¼˜è´¨</button>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterByRarity(4)">ç¨€æœ‰</button>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterByRarity(5)">å²è¯—</button>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterByRarity(6)">ä¼ è¯´</button>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterByRarity(7)">ç¥è¯</button>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterByRarity(8)">è¿œå¤</button>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterByRarity(9)">æ°¸æ’</button>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="filterByRarity(10)">è‡³é«˜</button>
        </div>
    </div>
</div>

<!-- æŒ‰ç¨€æœ‰åº¦åˆ†ç»„æ˜¾ç¤º -->
{% if fish_by_rarity %}
    {% for rarity in [10, 9, 8, 7, 6, 5, 4, 3, 2, 1] %}
        {% if rarity in fish_by_rarity %}
        <div class="row mb-2 rarity-section" data-rarity="{{ rarity }}">
            <div class="col-12">
                <h5>
                    <i class="fas fa-star"></i> 
                    {% if rarity == 1 %}æ™®é€š
                    {% elif rarity == 2 %}å¸¸è§
                    {% elif rarity == 3 %}ä¼˜è´¨
                    {% elif rarity == 4 %}ç¨€æœ‰
                    {% elif rarity == 5 %}å²è¯—
                    {% elif rarity == 6 %}ä¼ è¯´
                    {% elif rarity == 7 %}ç¥è¯
                    {% elif rarity == 8 %}è¿œå¤
                    {% elif rarity == 9 %}æ°¸æ’
                    {% elif rarity == 10 %}è‡³é«˜
                    {% else %}æœªçŸ¥
                    {% endif %}
                    ({{ fish_by_rarity[rarity]|length }} ç§)
                </h5>
            </div>
        </div>
        
        <div class="row g-2 mb-3 rarity-section" data-rarity="{{ rarity }}">
            {% for fish in fish_by_rarity[rarity] %}
            <div class="col-md-4 col-lg-3">
                <div class="card h-100 border-info">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <div class="flex-grow-1">
                                <h6 class="card-title mb-0">
                                    {{ fish.name }}
                                    {% if fish.quality_level == 1 %}
                                        <span class="badge bg-warning text-dark" style="font-size: 0.65rem;">âœ¨</span>
                                    {% endif %}
                                </h6>
                                <small class="badge bg-info" style="font-size: 0.65rem;">
                                    {% for i in range(fish.rarity) %}â˜…{% endfor %}
                                </small>
                            </div>
                            <h6 class="mb-0 text-primary">Ã—{{ fish.quantity }}</h6>
                        </div>
                        
                        <hr class="my-1">
                        
                        <div class="small mb-1">
                            <p class="mb-0">
                                <i class="fas fa-coins text-success"></i> 
                                {{ fish.actual_value }}
                            </p>
                            <p class="mb-0 text-muted" style="font-size: 0.7rem;">
                                <i class="fas fa-clock"></i> 
                                {{ fish.added_at }}
                            </p>
                        </div>
                        
                        <div class="d-grid">
                            <button class="btn btn-sm btn-warning" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;" onclick="removeFromAquarium({{ fish.fish_id }}, {{ fish.quality_level }}, '{{ fish.name }}', {{ fish.quantity }})">
                                <i class="fas fa-undo"></i> ç§»å›é±¼å¡˜
                            </button>
                        </div>
                        
                        <!-- å±•è§ˆè¯„è®ºæ˜¾ç¤º -->
                        {% set fish_key = fish.fish_id|string + '-' + fish.quality_level|string %}
                        {% if exhibition_comments and fish_key in exhibition_comments and exhibition_comments[fish_key]|length > 0 %}
                        <div class="mt-2 pt-2 border-top">
                            <div class="small">
                                <strong class="text-info"><i class="fas fa-comment"></i> å±•è§ˆç•™è¨€ ({{ exhibition_comments[fish_key]|length }})</strong>
                                <div class="mt-1" style="max-height: 150px; overflow-y: auto;">
                                    {% for comment in exhibition_comments[fish_key] %}
                                    <div class="alert alert-light py-1 mb-1" style="font-size: 0.75rem;" data-comment-id="{{ comment.id }}">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <strong>{{ comment.username }}:</strong>
                                                {{ comment.content }}
                                            </div>
                                            <button class="btn btn-sm btn-link text-danger p-0 ms-1" 
                                                    style="font-size: 0.7rem;"
                                                    onclick="deleteExhibitionCommentFromAquarium('{{ fish_key }}', '{{ comment.id }}')">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                        <div class="text-muted" style="font-size: 0.65rem;">{{ comment.timestamp }}</div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    {% endfor %}
{% else %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> æ°´æ—ç®±æ˜¯ç©ºçš„ï¼Œå°†çè´µçš„é±¼ä»é±¼å¡˜æ”¾å…¥è¿™é‡Œè§‚èµå§ï¼
        </div>
    </div>
</div>
{% endif %}

<!-- æç¤ºä¿¡æ¯ -->
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle"></i> æ¸©é¦¨æç¤º</h5>
            <ul class="mb-0">
                <li>æ°´æ—ç®±ç”¨äºæ”¶è—çè´µçš„é±¼ç±»ï¼Œä¸ä¼šè¢«å‡ºå”®</li>
                <li>å¯ä»¥é€šè¿‡å‡çº§æ‰©å¤§æ°´æ—ç®±å®¹é‡</li>
                <li>é«˜å“è´¨çš„é±¼åœ¨æ°´æ—ç®±ä¸­ä¼šæœ‰ç‰¹æ®Šæ•ˆæœ</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ç¨€æœ‰åº¦ç­›é€‰åŠŸèƒ½
function filterByRarity(rarity) {
    const sections = document.querySelectorAll('.rarity-section');
    const buttons = document.querySelectorAll('.btn-group button');
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    if (rarity === 'all') {
        sections.forEach(section => section.style.display = '');
    } else {
        sections.forEach(section => {
            if (section.dataset.rarity == rarity) {
                section.style.display = '';
            } else {
                section.style.display = 'none';
            }
        });
    }
}

async function removeFromAquarium(fishId, qualityLevel, fishName, maxQuantity) {
    const quantity = prompt(`è¯·è¾“å…¥è¦ç§»å›é±¼å¡˜çš„æ•°é‡ (æœ€å¤š ${maxQuantity} æ¡):`, '1');
    if (!quantity || quantity <= 0) return;
    
    const qty = parseInt(quantity);
    if (isNaN(qty) || qty <= 0 || qty > maxQuantity) {
        showToast('æ•°é‡æ— æ•ˆ', 'error');
        return;
    }
    
    try {
        const response = await fetch('{{ url_for("player_bp.api_remove_from_aquarium") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                fish_id: fishId,
                quality_level: qualityLevel,
                quantity: qty
            })
        });
        
        const data = await response.json();
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => location.reload(), 500);
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
    }
}

function showBatchRemoveFromAquarium() {
    // åˆ›å»ºæ¨¡æ€æ¡†HTML
    const modalHTML = `
        <div class="modal fade" id="batchRemoveModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-arrow-left"></i> æ‰¹é‡ç§»å›é±¼å¡˜</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="text-muted">é€‰æ‹©è¦ç§»å›é±¼å¡˜çš„é±¼çš„ç¨€æœ‰åº¦ï¼š</p>
                        <div id="rarityCheckboxes" class="d-flex flex-column gap-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="1" id="rarity1">
                                <label class="form-check-label" for="rarity1">â­ 1æ˜Ÿ - æ™®é€š</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="2" id="rarity2">
                                <label class="form-check-label" for="rarity2">â­â­ 2æ˜Ÿ - å¸¸è§</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="3" id="rarity3">
                                <label class="form-check-label" for="rarity3">â­â­â­ 3æ˜Ÿ - ä¼˜è´¨</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="4" id="rarity4">
                                <label class="form-check-label" for="rarity4">â­â­â­â­ 4æ˜Ÿ - ç¨€æœ‰</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="5" id="rarity5">
                                <label class="form-check-label" for="rarity5">â­â­â­â­â­ 5æ˜Ÿ - å²è¯—</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="6" id="rarity6">
                                <label class="form-check-label" for="rarity6">ğŸŒŸ 6æ˜Ÿ - ä¼ è¯´</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="7" id="rarity7">
                                <label class="form-check-label" for="rarity7">ğŸŒŸ 7æ˜Ÿ - ç¥è¯</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="8" id="rarity8">
                                <label class="form-check-label" for="rarity8">ğŸŒŸ 8æ˜Ÿ - è¿œå¤</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="9" id="rarity9">
                                <label class="form-check-label" for="rarity9">ğŸ’« 9æ˜Ÿ - æ°¸æ’</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="10" id="rarity10">
                                <label class="form-check-label" for="rarity10">âœ¨ 10æ˜Ÿ - è‡³é«˜</label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                        <button type="button" class="btn btn-primary" onclick="executeBatchRemoveFromAquarium()">
                            <i class="fas fa-check"></i> ç¡®è®¤ç§»å›
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // æ·»åŠ åˆ°é¡µé¢
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    const modal = new bootstrap.Modal(document.getElementById('batchRemoveModal'));
    modal.show();
    
    // å…³é—­æ—¶ç§»é™¤DOM
    document.getElementById('batchRemoveModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

async function executeBatchRemoveFromAquarium() {
    const selectedRarities = [];
    for (let i = 1; i <= 10; i++) {
        const checkbox = document.getElementById(`rarity${i}`);
        if (checkbox && checkbox.checked) {
            selectedRarities.push(i);
        }
    }
    
    if (selectedRarities.length === 0) {
        showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç¨€æœ‰åº¦', 'warning');
        return;
    }
    
    // å…³é—­æ¨¡æ€æ¡†
    bootstrap.Modal.getInstance(document.getElementById('batchRemoveModal')).hide();
    
    // æ˜¾ç¤ºåŠ è½½æç¤º
    showToast('æ­£åœ¨æ‰¹é‡ç§»å›...', 'info');
    
    try {
        const response = await fetch('{{ url_for("player_bp.api_batch_remove_from_aquarium") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ rarities: selectedRarities })
        });
        
        const data = await response.json();
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
    }
}

// ä»æ°´æ—ç®±åˆ é™¤å±•è§ˆè¯„è®º
async function deleteExhibitionCommentFromAquarium(fishKey, commentId) {
    if (!confirm('ç¡®è®¤åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿ')) {
        return;
    }
    
    try {
        const response = await fetch('{{ url_for("player_bp.api_delete_exhibition_comment") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                fish_key: fishKey,
                comment_id: commentId 
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('ç•™è¨€å·²åˆ é™¤', 'success');
            // ç§»é™¤è¯„è®ºå…ƒç´ 
            const element = document.querySelector(`[data-comment-id="${commentId}"]`);
            if (element) {
                element.style.transition = 'opacity 0.3s';
                element.style.opacity = '0';
                setTimeout(() => element.remove(), 300);
            }
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
    }
}
</script>
{% endblock %}
