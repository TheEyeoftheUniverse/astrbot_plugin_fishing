{% extends "layout.html" %}

{% block title %}商店 - 钓鱼游戏{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="mb-0">
            <i class="fas fa-store"></i> 商店
        </h2>
        <p class="text-muted mt-2">购买游戏道具、装备和鱼饵</p>
    </div>
</div>

<!-- 用户信息 -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-coins"></i> 我的金币</h5>
                <h2 class="mb-0">{{ user.coins or 0 }}</h2>
            </div>
        </div>
    </div>
</div>

<!-- 商店列表 -->
{% if shops %}
    {% for shop in shops %}
    <div class="card mb-4">
        <div class="card-header bg-info text-white" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#shop-{{ shop.shop_id }}-collapse">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">
                        <i class="fas fa-shop"></i> {{ shop.name }}
                    </h4>
                    {% if shop.description %}
                    <small>{{ shop.description }}</small>
                    {% endif %}
                </div>
                <i class="fas fa-chevron-down"></i>
            </div>
        </div>
        <div class="collapse" id="shop-{{ shop.shop_id }}-collapse">
        <div class="card-body">
            <!-- 商品网格 -->
            <div class="row g-3" id="shop-{{ shop.shop_id }}">
                {% if shop.item_list %}
                    {% for item_data in shop.item_list %}
                    {% set item = item_data.item %}
                    {% set costs = item_data.costs %}
                    {% set rewards = item_data.rewards %}
                    
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100">
                            <div class="card-body d-flex flex-column">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title mb-0">{{ item.item_name }}</h5>
                                    {% if item.stock_total %}
                                    <span class="badge bg-secondary">库存: {{ item.stock_total - (item.stock_sold or 0) }}</span>
                                    {% endif %}
                                </div>
                                
                                {% if item.description %}
                                <p class="card-text text-muted small mb-2">{{ item.description }}</p>
                                {% endif %}
                                
                                <hr class="my-2">
                                
                                <!-- 成本显示 -->
                                <div class="mb-2">
                                    {# 先过滤掉无效的消耗项 #}
                                    {% set valid_costs = [] %}
                                    {% for cost in costs %}
                                        {% if cost.cost_type and cost.cost_amount and cost.cost_amount > 0 %}
                                            {% set _ = valid_costs.append(cost) %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {# 检测是否有or逻辑 #}
                                    {% set has_or = namespace(value=False) %}
                                    {% for cost in valid_costs %}
                                        {% if cost.is_or %}
                                            {% set has_or.value = True %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <strong class="small">所需{% if has_or.value %}（满足任一条件即可）{% endif %}:</strong>
                                    <div class="small">
                                        {% for cost in valid_costs %}
                                            {# 在or项之前显示分隔符 #}
                                            {% if loop.index > 1 and cost.is_or %}
                                                <div class="text-center my-2">
                                                    <span class="badge bg-warning text-dark"><i class="fas fa-arrows-alt-v"></i> 或 <i class="fas fa-arrows-alt-v"></i></span>
                                                </div>
                                            {% endif %}
                                            
                                            {# or项加上边框高亮 #}
                                            <div class="{% if cost.is_or or (loop.index < valid_costs|length and valid_costs[loop.index0 + 1].is_or) %}border border-warning rounded p-2 mb-1 bg-warning bg-opacity-10{% endif %}">
                                                {% if cost.cost_type == 'coins' %}
                                                    <i class="fas fa-coins text-warning"></i> {{ cost.cost_amount }} 金币
                                                {% elif cost.cost_type == 'premium' %}
                                                    <i class="fas fa-gem text-info"></i> {{ cost.cost_amount }} 钻石
                                                {% elif cost.cost_type == 'item' %}
                                                    <i class="fas fa-cube"></i> {{ cost.cost_item_name or '道具' }} x{{ cost.cost_amount }}
                                                {% elif cost.cost_type == 'fish' %}
                                                    <i class="fas fa-fish"></i> {{ cost.cost_item_name or '鱼类' }} x{{ cost.cost_amount }}
                                                {% elif cost.cost_type == 'bait' %}
                                                    <i class="fas fa-cookie-bite"></i> {{ cost.cost_item_name or '鱼饵' }} x{{ cost.cost_amount }}
                                                {% elif cost.cost_type == 'rod' %}
                                                    <i class="fas fa-fishing-rod"></i> {{ cost.cost_item_name or '鱼竿' }} x{{ cost.cost_amount }}
                                                {% elif cost.cost_type == 'accessory' %}
                                                    <i class="fas fa-ring"></i> {{ cost.cost_item_name or '饰品' }} x{{ cost.cost_amount }}
                                                {% endif %}
                                                {% if cost.satisfied %}
                                                    <i class="fas fa-check-circle text-success" style="font-size: 0.8em;"></i>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                
                                <!-- 奖励显示 -->
                                <div class="mb-2">
                                    <strong class="small">获得:</strong>
                                    <div class="small text-success">
                                        {% for reward in rewards %}
                                        <div>
                                            {% if reward.reward_type == 'coins' %}
                                                <i class="fas fa-coins"></i> {{ reward.reward_amount }} 金币
                                            {% elif reward.reward_type == 'premium' %}
                                                <i class="fas fa-gem"></i> {{ reward.reward_amount }} 钻石
                                            {% elif reward.reward_type == 'item' %}
                                                <i class="fas fa-cube"></i> {{ reward.reward_item_name or '道具' }} x{{ reward.reward_quantity or reward.reward_amount or 1 }}
                                            {% elif reward.reward_type == 'rod' %}
                                                <i class="fas fa-fishing-rod"></i> {{ reward.reward_item_name or '鱼竿' }}
                                                {% if reward.reward_refine_level and reward.reward_refine_level > 0 %}
                                                    <span class="badge bg-warning text-dark">+{{ reward.reward_refine_level }}</span>
                                                {% endif %}
                                                {% if reward.attributes %}
                                                    <div class="text-muted" style="font-size: 0.85em;">{{ reward.attributes }}</div>
                                                {% endif %}
                                            {% elif reward.reward_type == 'accessory' %}
                                                <i class="fas fa-ring"></i> {{ reward.reward_item_name or '饰品' }}
                                                {% if reward.reward_refine_level and reward.reward_refine_level > 0 %}
                                                    <span class="badge bg-warning text-dark">+{{ reward.reward_refine_level }}</span>
                                                {% endif %}
                                                {% if reward.attributes %}
                                                    <div class="text-muted" style="font-size: 0.85em;">{{ reward.attributes }}</div>
                                                {% endif %}
                                            {% elif reward.reward_type == 'bait' %}
                                                <i class="fas fa-cookie-bite"></i> {{ reward.reward_item_name or '鱼饵' }} x{{ reward.reward_quantity or reward.reward_amount or 1 }}
                                                {% if reward.attributes %}
                                                    <div class="text-muted" style="font-size: 0.85em;">{{ reward.attributes }}</div>
                                                {% endif %}
                                            {% elif reward.reward_type == 'fish' %}
                                                <i class="fas fa-fish"></i> {{ reward.reward_item_name or '鱼类' }} x{{ reward.reward_quantity or reward.reward_amount or 1 }}
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                
                                <!-- 限购信息 -->
                                {% if item.per_user_limit or item.per_user_daily_limit %}
                                <div class="small text-muted mb-2">
                                    {% if item.per_user_limit %}
                                    <div><i class="fas fa-exclamation-circle"></i> 限购 {{ item.per_user_limit }} 个</div>
                                    {% endif %}
                                    {% if item.per_user_daily_limit %}
                                    <div><i class="fas fa-calendar"></i> 每日限购 {{ item.per_user_daily_limit }} 个</div>
                                    {% endif %}
                                </div>
                                {% endif %}
                                
                                <div class="mt-auto">
                                    <button class="btn btn-primary btn-sm w-100" onclick="buyShopItem({{ item.item_id }}, '{{ item.item_name }}')">
                                        <i class="fas fa-shopping-cart"></i> 购买
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 该商店暂无商品
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        </div>
    </div>
    {% endfor %}
{% else %}
<div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle"></i> 暂无可用商店
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
async function buyShopItem(itemId, itemName) {
    const quantity = prompt(`请输入购买 ${itemName} 的数量:`, '1');
    if (!quantity || quantity <= 0) return;
    
    const qty = parseInt(quantity);
    if (isNaN(qty) || qty <= 0) {
        showToast('数量无效', 'error');
        return;
    }
    
    try {
        const response = await fetch('{{ url_for("player_bp.api_buy_shop_item") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ item_id: itemId, quantity: qty })
        });
        
        const data = await response.json();
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => location.reload(), 800);
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        showToast('网络错误，请稍后重试', 'error');
    }
}
</script>
{% endblock %}
