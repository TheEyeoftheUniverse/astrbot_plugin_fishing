{% extends "layout.html" %}

{% block title %}æŠ½å¡ - é’“é±¼æ’ä»¶{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="fas fa-dice"></i> æŠ½å¡ç³»ç»Ÿ</h2>
        <p class="text-muted">è¯•è¯•è¿æ°”ï¼ŒæŠ½å–ç¨€æœ‰ç‰©å“ï¼</p>
    </div>
</div>

<!-- ç”¨æˆ·èµ„äº§æ˜¾ç¤º -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card bg-warning bg-opacity-10">
            <div class="card-body d-flex align-items-center">
                <i class="fas fa-coins fa-3x text-warning me-3"></i>
                <div>
                    <h6 class="mb-0 text-muted">é‡‘å¸</h6>
                    <h3 class="mb-0">{{ user.coins | default(0) }}</h3>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card bg-info bg-opacity-10">
            <div class="card-body d-flex align-items-center">
                <i class="fas fa-gem fa-3x text-info me-3"></i>
                <div>
                    <h6 class="mb-0 text-muted">é«˜çº§è´§å¸</h6>
                    <h3 class="mb-0">{{ user.premium_currency | default(0) }}</h3>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å¡æ± åˆ—è¡¨ -->
<div class="row">
    {% for pool in pools %}
    <div class="col-lg-6 mb-4">
        <div class="card h-100 {% if pool.is_limited_time %}border-danger{% endif %} d-flex flex-column">
            <div class="card-header {% if pool.is_limited_time %}bg-danger text-white{% else %}bg-primary text-white{% endif %}">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-gift"></i> {{ pool.name }}
                    </h5>
                    {% if pool.is_limited_time %}
                    <span class="badge bg-warning text-dark">é™æ—¶</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body d-flex flex-column">
                <!-- å¡æ± æè¿° -->
                <p class="text-muted">{{ pool.description }}</p>
                
                {% if pool.is_limited_time and pool.open_until %}
                <div class="alert alert-warning small mb-3">
                    <i class="fas fa-clock"></i> é™æ—¶å¼€æ”¾è‡³: {{ pool.open_until.strftime('%Y-%m-%d %H:%M') if pool.open_until else pool.open_until }}
                </div>
                {% endif %}
                
                <!-- è´¹ç”¨ä¿¡æ¯ -->
                <div class="mb-3">
                    <h6 class="text-muted mb-2">æŠ½å¡è´¹ç”¨</h6>
                    <div class="d-flex justify-content-between align-items-center">
                        <span>å•æŠ½:</span>
                        {% if pool.cost_premium_currency > 0 %}
                        <strong class="text-info">
                            <i class="fas fa-gem"></i> {{ pool.cost_premium_currency }} é«˜çº§è´§å¸
                        </strong>
                        {% else %}
                        <strong class="text-warning">
                            <i class="fas fa-coins"></i> {{ pool.cost_coins }} é‡‘å¸
                        </strong>
                        {% endif %}
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span>åè¿:</span>
                        {% if pool.cost_premium_currency > 0 %}
                        <strong class="text-info">
                            <i class="fas fa-gem"></i> {{ pool.cost_premium_currency * 10 }} é«˜çº§è´§å¸
                        </strong>
                        {% else %}
                        <strong class="text-warning">
                            <i class="fas fa-coins"></i> {{ pool.cost_coins * 10 }} é‡‘å¸
                        </strong>
                        {% endif %}
                    </div>
                </div>
                
                <!-- ä»Šæ—¥å…è´¹æ¬¡æ•° -->
                {% if pool.is_free %}
                <div class="alert alert-success mb-3">
                    <i class="fas fa-gift"></i> 
                    {% if pool.drawn_today %}
                    ä»Šæ—¥å…è´¹è¡¥ç»™å·²é¢†å–ï¼Œæ˜å¤©å†æ¥ï¼
                    {% else %}
                    æ¯æ—¥å…è´¹è¡¥ç»™å¯ç”¨ï¼
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- å¥–å“é¢„è§ˆ -->
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-info w-100" onclick="showPoolDetails({{ pool.gacha_pool_id }})">
                        <i class="fas fa-eye"></i> æŸ¥çœ‹å¥–å“è¯¦æƒ…
                    </button>
                </div>
                
                <!-- æ’‘å¼€ç©ºé—´ -->
                <div class="flex-grow-1"></div>
                
                <hr>
                
                <!-- æŠ½å¡æ“ä½œ -->
                <div class="row g-2">
                    <div class="col-6">
                        <button class="btn btn-success w-100" 
                                onclick="performDraw({{ pool.gacha_pool_id }}, 1, '{{ pool.name }}')"
                                {% if pool.is_free and pool.drawn_today %}disabled{% endif %}>
                            <i class="fas fa-dice-one"></i> å•æŠ½
                        </button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-primary w-100" 
                                onclick="performDraw({{ pool.gacha_pool_id }}, 10, '{{ pool.name }}')"
                                {% if pool.is_free %}disabled{% endif %}>
                            <i class="fas fa-dice-d20"></i> åè¿
                        </button>
                    </div>
                </div>
                
                <!-- å¤šæ¬¡åè¿æŒ‰é’® -->
                {% if not pool.is_free %}
                <div class="mt-2">
                    <button class="btn btn-warning w-100" 
                            onclick="performMultiDraw({{ pool.gacha_pool_id }}, '{{ pool.name }}')">
                        <i class="fas fa-dice"></i> å¤šæ¬¡åè¿
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- æŠ½å¡è®°å½• -->
{% if recent_records %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-history"></i> æœ€è¿‘æŠ½å¡è®°å½•</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>æ—¶é—´</th>
                                <th>å¡æ± </th>
                                <th>ç‰©å“</th>
                                <th>ç¨€æœ‰åº¦</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in recent_records %}
                            <tr>
                                <td>{{ record.created_at.strftime('%m-%d %H:%M') if record.created_at else '-' }}</td>
                                <td>{{ record.pool_name }}</td>
                                <td>{{ record.item_name }}</td>
                                <td>
                                    {% if record.item_rarity %}
                                    <span class="text-warning">{{ 'â­' * record.item_rarity }}</span>
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- å¥–å“è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="poolDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-gift"></i> å¡æ± å¥–å“è¯¦æƒ…</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="poolDetailsContent">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æŠ½å¡ç»“æœæ¨¡æ€æ¡† -->
<div class="modal fade" id="drawResultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-trophy"></i> æŠ½å¡ç»“æœ</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="drawResultContent">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="location.reload()">
                    <i class="fas fa-sync"></i> åˆ·æ–°é¡µé¢
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// æŸ¥çœ‹å¡æ± è¯¦æƒ…
async function showPoolDetails(poolId) {
    const modal = new bootstrap.Modal(document.getElementById('poolDetailsModal'));
    modal.show();
    
    try {
        const response = await fetch(`{{ url_for("player_bp.api_get_pool_details") }}?pool_id=${poolId}`);
        const data = await response.json();
        
        if (data.success) {
            const pool = data.pool;
            const probabilities = data.probabilities;
            
            let html = `<h5 class="mb-3">${pool.name}</h5>`;
            html += `<p class="text-muted">${pool.description}</p>`;
            html += '<hr><h6>å¥–å“åˆ—è¡¨åŠæ¦‚ç‡ï¼š</h6>';
            html += '<div class="table-responsive"><table class="table table-hover">';
            html += '<thead><tr><th>ç‰©å“</th><th>ç¨€æœ‰åº¦</th><th>æ¦‚ç‡</th></tr></thead><tbody>';
            
            for (const item of probabilities) {
                const stars = item.item_rarity > 0 ? 'â­'.repeat(item.item_rarity) : '-';
                const probability = (item.probability * 100).toFixed(2) + '%';
                html += `<tr>
                    <td>${item.item_name}</td>
                    <td><span class="text-warning">${stars}</span></td>
                    <td>${probability}</td>
                </tr>`;
            }
            
            html += '</tbody></table></div>';
            document.getElementById('poolDetailsContent').innerHTML = html;
        } else {
            document.getElementById('poolDetailsContent').innerHTML = 
                `<div class="alert alert-danger">${data.message}</div>`;
        }
    } catch (error) {
        document.getElementById('poolDetailsContent').innerHTML = 
            '<div class="alert alert-danger">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
    }
}

// æ‰§è¡ŒæŠ½å¡
async function performDraw(poolId, numDraws, poolName) {
    const drawType = numDraws === 1 ? 'å•æŠ½' : 'åè¿';
    if (!confirm(`ç¡®è®¤åœ¨ã€${poolName}ã€‘è¿›è¡Œ${drawType}å—ï¼Ÿ`)) {
        return;
    }
    
    try {
        const response = await fetch('{{ url_for("player_bp.api_perform_draw") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                pool_id: poolId,
                num_draws: numDraws
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showDrawResult(data.results, numDraws);
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
    }
}

// å¤šæ¬¡åè¿
async function performMultiDraw(poolId, poolName) {
    const times = prompt(`ã€${poolName}ã€‘å¤šæ¬¡åè¿\nè¯·è¾“å…¥åè¿æ¬¡æ•°ï¼ˆ1-100ï¼‰:`, '5');
    if (!times) return;
    
    const numTimes = parseInt(times);
    if (isNaN(numTimes) || numTimes < 1 || numTimes > 100) {
        showToast('æ¬¡æ•°å¿…é¡»åœ¨1-100ä¹‹é—´', 'error');
        return;
    }
    
    if (!confirm(`ç¡®è®¤è¿›è¡Œ${numTimes}æ¬¡åè¿ï¼ˆå…±${numTimes * 10}æŠ½ï¼‰å—ï¼Ÿ`)) {
        return;
    }
    
    showToast('æŠ½å¡ä¸­ï¼Œè¯·ç¨å€™...', 'info');
    
    try {
        const response = await fetch('{{ url_for("player_bp.api_perform_multi_draw") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                pool_id: poolId,
                times: numTimes
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMultiDrawResult(data);
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
    }
}

// æ˜¾ç¤ºæŠ½å¡ç»“æœ
function showDrawResult(results, numDraws) {
    let html = '<h5 class="mb-3">ğŸ‰ æ­å–œï¼æ‚¨è·å¾—äº†ï¼š</h5>';
    html += '<div class="row">';
    
    for (const item of results) {
        const stars = item.rarity > 0 ? 'â­'.repeat(item.rarity) : '';
        const rarityClass = item.rarity >= 5 ? 'border-warning' : item.rarity >= 3 ? 'border-info' : '';
        
        html += `<div class="col-md-6 mb-3">
            <div class="card ${rarityClass}">
                <div class="card-body text-center">
                    <div class="text-warning mb-2">${stars}</div>
                    <h6>${item.name}</h6>
                    ${item.type === 'coins' ? `<p class="text-muted mb-0">${item.quantity} é‡‘å¸</p>` : ''}
                </div>
            </div>
        </div>`;
    }
    
    html += '</div>';
    
    document.getElementById('drawResultContent').innerHTML = html;
    const modal = new bootstrap.Modal(document.getElementById('drawResultModal'));
    modal.show();
}

// æ˜¾ç¤ºå¤šæ¬¡åè¿ç»“æœ
function showMultiDrawResult(data) {
    let html = `<h5 class="mb-3">ğŸ‰ ${data.times}æ¬¡åè¿å®Œæˆï¼</h5>`;
    
    // æ¶ˆè€—ç»Ÿè®¡
    html += `<div class="alert alert-info">
        <h6>ğŸ’° æ¶ˆè€—ç»Ÿè®¡</h6>
        <p class="mb-0">å…±æ¶ˆè€—: ${data.total_cost} ${data.cost_type}</p>
        <p class="mb-0">å…±è·å¾—: ${data.total_items} ä»¶ç‰©å“</p>
    </div>`;
    
    // ç¨€æœ‰åº¦ç»Ÿè®¡
    if (data.rarity_counts) {
        html += '<div class="alert alert-success"><h6>ğŸ“Š ç¨€æœ‰åº¦ç»Ÿè®¡</h6>';
        for (let rarity = 10; rarity >= 1; rarity--) {
            if (data.rarity_counts[rarity] > 0) {
                const stars = 'â­'.repeat(rarity);
                html += `<div>${stars} Ã— ${data.rarity_counts[rarity]}</div>`;
            }
        }
        html += '</div>';
    }
    
    // ç‰©å“è¯¦æƒ…
    if (data.item_counts) {
        html += '<div class="alert alert-primary"><h6>ğŸ ç‰©å“è¯¦æƒ…</h6>';
        const items = Object.entries(data.item_counts).sort((a, b) => b[1] - a[1]);
        for (const [name, count] of items) {
            html += `<div>${name} Ã— ${count}</div>`;
        }
        html += '</div>';
    }
    
    // é‡‘å¸ç»Ÿè®¡
    if (data.coin_total > 0) {
        html += `<div class="alert alert-warning">
            <h6>ğŸ’° é‡‘å¸æ€»è®¡</h6>
            <p class="mb-0">${data.coin_total.toLocaleString()} é‡‘å¸</p>
        </div>`;
    }
    
    document.getElementById('drawResultContent').innerHTML = html;
    const modal = new bootstrap.Modal(document.getElementById('drawResultModal'));
    modal.show();
}
</script>
{% endblock %}
