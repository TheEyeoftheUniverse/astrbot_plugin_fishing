{% extends "user_layout.html" %}

{% block content %}
<h4 class="mb-4"><i class="fas fa-book me-2"></i>鱼类图鉴</h4>

<div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
        <h6 class="mb-0">搜索和过滤</h6>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <input type="text" id="searchInput" class="form-control" placeholder="搜索鱼类...">
            </div>
            <div class="col-md-4">
                <select id="qualityFilter" class="form-select">
                    <option value="">所有品质</option>
                    <option value="1">普通</option>
                    <option value="2">稀有</option>
                    <option value="3">史诗</option>
                    <option value="4">传说</option>
                    <option value="5">神话</option>
                </select>
            </div>
            <div class="col-md-4">
                <button class="btn btn-primary w-100" onclick="filterPokedex()">
                    <i class="fas fa-search me-2"></i>搜索
                </button>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h6 class="mb-0">已捕获的鱼类 (<span id="caughtCount">0</span>/<span id="totalCount">0</span>)</h6>
        <small class="text-muted">点击鱼类查看详情</small>
    </div>
    <div class="card-body">
        <div id="pokedexList" class="row">
            <div class="col-12 text-center text-muted">
                <p><i class="fas fa-spinner fa-spin me-2"></i>加载中...</p>
            </div>
        </div>
    </div>
</div>

<style>
    .fish-card {
        background: white;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
        border: 2px solid #dee2e6;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
    }
    .fish-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    .fish-card.caught {
        border-color: #28a745;
        background: rgba(40, 167, 69, 0.05);
    }
    .fish-card.uncaught {
        border-color: #6c757d;
        background: rgba(108, 117, 125, 0.05);
        opacity: 0.6;
    }
    
    .rarity-1 { border-left: 4px solid #95a5a6 !important; }
    .rarity-2 { border-left: 4px solid #3498db !important; }
    .rarity-3 { border-left: 4px solid #9b59b6 !important; }
    .rarity-4 { border-left: 4px solid #f39c12 !important; }
    .rarity-5 { border-left: 4px solid #e74c3c !important; }
    
    .caught-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #28a745;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
    }
    
    .uncaught-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #6c757d;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
    }
</style>

<!-- 鱼类详情模态框 -->
<div class="modal fade" id="fishDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fishDetailTitle">鱼类详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="fishDetailContent">
                <div class="text-center">
                    <p><i class="fas fa-spinner fa-spin me-2"></i>加载中...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let allFishData = [];
    let caughtFishIds = new Set();

    // 加载鱼类图鉴
    async function loadPokedex() {
        try {
            // 先加载已捕获的鱼
            const fishResponse = await fetch('/api/user/fish');
            if (fishResponse.ok) {
                const fishData = await fishResponse.json();
                if (fishData.success && fishData.data) {
                    caughtFishIds = new Set(fishData.data.map(f => f.fish_id));
                }
            }

            // 加载所有鱼类模板
            const templateResponse = await fetch('/api/user/fish-templates');
            if (!templateResponse.ok) {
                alert('加载失败，请检查网络连接');
                return;
            }

            const templateData = await templateResponse.json();
            if (!templateData.success || !templateData.data) {
                document.getElementById('pokedexList').innerHTML = '<div class="col-12 text-center text-muted"><p>没有可用的鱼类数据</p></div>';
                return;
            }

            allFishData = templateData.data;
            displayPokedex(allFishData);
        } catch (error) {
            console.error('加载图鉴失败:', error);
            alert('加载失败: ' + error.message);
        }
    }

    // 显示鱼类图鉴
    function displayPokedex(fishList) {
        const caughtCount = fishList.filter(f => caughtFishIds.has(f.id)).length;
        const totalCount = fishList.length;

        document.getElementById('caughtCount').textContent = caughtCount;
        document.getElementById('totalCount').textContent = totalCount;

        if (fishList.length === 0) {
            document.getElementById('pokedexList').innerHTML = '<div class="col-12 text-center text-muted"><p>没有找到匹配的鱼类</p></div>';
            return;
        }

        let html = '';
        for (const fish of fishList) {
            const isCaught = caughtFishIds.has(fish.id);
            const qualityLevel = fish.quality_level || 1;
            const statusClass = isCaught ? 'caught' : 'uncaught';
            const statusBadge = isCaught ? 
                `<div class="caught-badge"><i class="fas fa-check me-1"></i>已捕获</div>` :
                `<div class="uncaught-badge"><i class="fas fa-lock me-1"></i>未捕获</div>`;

            html += `
                <div class="col-md-6 col-lg-4">
                    <div class="fish-card rarity-${qualityLevel} ${statusClass}" onclick="showFishDetail(${fish.id})">
                        ${statusBadge}
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${fish.name || '鱼类' + fish.id}</h6>
                                <small class="text-muted">
                                    ID: ${fish.id}<br>
                                    品质: ${qualityLevel}<br>
                                    重量: ${fish.weight || 'N/A'}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        document.getElementById('pokedexList').innerHTML = html;
    }

    // 过滤图鉴
    function filterPokedex() {
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        const qualityFilter = document.getElementById('qualityFilter').value;

        let filtered = allFishData.filter(fish => {
            const matchName = !searchText || (fish.name || '').toLowerCase().includes(searchText) || fish.id.toString().includes(searchText);
            const matchQuality = !qualityFilter || fish.quality_level === parseInt(qualityFilter);
            return matchName && matchQuality;
        });

        displayPokedex(filtered);
    }

    // 显示鱼类详情
    async function showFishDetail(fishId) {
        try {
            const fish = allFishData.find(f => f.id === fishId);
            if (!fish) {
                alert('鱼类信息不存在');
                return;
            }

            const isCaught = caughtFishIds.has(fishId);
            const qualityNames = ['', '普通', '稀有', '史诗', '传说', '神话'];
            const qualityLevel = fish.quality_level || 1;

            let html = `
                <div class="text-center mb-3">
                    <h5>${fish.name || '鱼类' + fish.id}</h5>
                    <p>
                        <span class="badge bg-info">ID: ${fish.id}</span>
                        <span class="badge bg-warning">品质: ${qualityNames[qualityLevel] || '未知'}</span>
                    </p>
                </div>
                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <th>描述</th>
                            <td>${fish.description || '暂无描述'}</td>
                        </tr>
                        <tr>
                            <th>基础重量</th>
                            <td>${fish.weight || 'N/A'} kg</td>
                        </tr>
                        <tr>
                            <th>掉落概率</th>
                            <td>${fish.drop_rate || 'N/A'}%</td>
                        </tr>
                        <tr>
                            <th>出没区域</th>
                            <td>${fish.zones || '未知'}</td>
                        </tr>
                        <tr>
                            <th>捕获状态</th>
                            <td>
                                ${isCaught ? 
                                    '<span class="badge bg-success"><i class="fas fa-check me-1"></i>已捕获</span>' :
                                    '<span class="badge bg-secondary"><i class="fas fa-lock me-1"></i>未捕获</span>'
                                }
                            </td>
                        </tr>
                    </tbody>
                </table>
            `;

            document.getElementById('fishDetailTitle').textContent = fish.name || '鱼类详情';
            document.getElementById('fishDetailContent').innerHTML = html;
            
            const modal = new bootstrap.Modal(document.getElementById('fishDetailModal'));
            modal.show();
        } catch (error) {
            console.error('显示详情失败:', error);
            alert('加载详情失败: ' + error.message);
        }
    }

    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', loadPokedex);

    // 搜索框回车搜索
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') filterPokedex();
        });
    });
</script>
{% endblock %}
